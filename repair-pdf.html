<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair PDF - Passion Tools</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

    <style>
        :root {
            /* --- Brand Colors --- */
            --red: #ef4444;
            --purple: #a855f7;
            --blue: #3b82f6;
            --green: #22c55e;
            --orange: #f97316;
            
            /* --- UI Colors --- */
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            
            /* --- Spacing & Shadows --- */
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --transition: all 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header --- */
        header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-text { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .logo-passion { color: #1f2937; }
        .logo-tools {
            background: linear-gradient(to right, var(--red), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .back-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        .back-link:hover { color: var(--red); }

        /* --- Main Layout --- */
        .tool-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
            flex: 1;
            width: 100%;
        }

        .tool-header { text-align: center; margin-bottom: 40px; }
        .tool-title { font-size: 36px; font-weight: 800; margin-bottom: 12px; }
        .tool-subtitle { color: var(--text-secondary); font-size: 18px; }

        /* --- Stages --- */
        .stage { display: none; animation: fadeIn 0.4s ease; }
        .stage.active { display: block; }

        /* --- 1. Upload Stage --- */
        .upload-area {
            background: #ffffff;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 80px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--blue);
            background-color: rgba(59, 130, 246, 0.05);
        }
        .upload-icon { font-size: 48px; color: var(--blue); margin-bottom: 16px; }
        .upload-text { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .upload-subtext { color: var(--text-secondary); font-size: 14px; }

        /* --- 2. Process Stage --- */
        .process-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .file-info {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            font-size: 14px;
            color: var(--text-primary);
        }

        .progress-container {
            margin: 30px 0;
            text-align: left;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, var(--blue), var(--purple));
            transition: width 0.3s ease;
        }

        /* Log Terminal Style */
        .status-log {
            background: #1f2937;
            color: #10b981; /* Terminal Green */
            font-family: monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            height: 120px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.6;
            border: 1px solid #374151;
        }
        .log-item { display: block; margin-bottom: 4px; }
        .log-item.error { color: #ef4444; }
        .log-item.warn { color: #f59e0b; }

        /* --- 3. Result Stage --- */
        .result-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .result-icon { font-size: 50px; margin-bottom: 20px; }
        .result-icon.success { color: var(--green); }
        .result-icon.error { color: var(--red); }

        .btn-download {
            background-color: var(--green);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            margin-top: 20px;
        }
        .btn-download:hover { background-color: #16a34a; transform: translateY(-2px); }

        .btn-reset {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 500;
            transition: var(--transition);
        }
        .btn-reset:hover { background: #fee2e2; border-color: #fecaca; color: var(--red); }

        /* --- Footer --- */
        footer {
            background-color: #111827;
            color: white;
            padding: 40px 0;
            margin-top: auto;
            text-align: center;
        }
        footer p { opacity: 0.8; font-size: 14px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-text">
                    <span class="logo-passion">Passion</span><span class="logo-tools">Tools</span>
                </div>
                <a href="index.html" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Tools
                </a>
            </div>
        </div>
    </header>

    <main class="tool-container">
        <div class="tool-header">
            <h1 class="tool-title">Repair PDF</h1>
            <p class="tool-subtitle">Recover data from corrupted files and fix PDF structural errors.</p>
        </div>

        <div class="stage active" id="stageUpload">
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-hammer upload-icon"></i>
                <div class="upload-text">Click or Drag & Drop Corrupted PDF</div>
                <div class="upload-subtext">We'll attempt to reconstruct the file structure</div>
                <input type="file" id="fileInput" accept="application/pdf" style="display: none;">
            </div>
        </div>

        <div class="stage" id="stageProcess">
            <div class="process-card">
                <div class="file-info">
                    <i class="fas fa-file-pdf" style="color: var(--red);"></i>
                    <span id="processFileName">document.pdf</span>
                </div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span id="progressText">Initializing...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressBar"></div>
                    </div>
                </div>

                <div class="status-log" id="statusLog">
                    </div>
            </div>
        </div>

        <div class="stage" id="stageResult">
            <div class="result-card">
                <div id="resultIconWrapper">
                    <i class="fas fa-check-circle result-icon success"></i>
                </div>
                
                <h2 id="resultTitle">Repair Successful!</h2>
                <p id="resultDesc" style="color: var(--text-secondary); margin-bottom: 20px;">
                    We successfully reconstructed the XREF table and file objects.
                </p>

                <a href="#" class="btn-download" id="downloadBtn">
                    <i class="fas fa-download"></i> Download Repaired PDF
                </a>
                
                <br>
                <button class="btn-reset" onclick="location.reload()">Repair Another File</button>
            </div>
        </div>

    </main>

    <footer>
        <div class="container">
            <p>&copy; 2026 Passion Tools. Secure client-side processing.</p>
        </div>
    </footer>

    <script>
        // DOM Elements
        const stageUpload = document.getElementById('stageUpload');
        const stageProcess = document.getElementById('stageProcess');
        const stageResult = document.getElementById('stageResult');
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        const processFileName = document.getElementById('processFileName');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const statusLog = document.getElementById('statusLog');
        
        const resultIconWrapper = document.getElementById('resultIconWrapper');
        const resultTitle = document.getElementById('resultTitle');
        const resultDesc = document.getElementById('resultDesc');
        const downloadBtn = document.getElementById('downloadBtn');

        // State
        let currentFile = null;

        // --- 1. Upload Logic ---
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.add('dragover'); 
        });
        
        uploadArea.addEventListener('dragleave', () => { 
            uploadArea.classList.remove('dragover'); 
        });
        
        uploadArea.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]); 
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            // Ensure libraries are loaded
            if (typeof PDFLib === 'undefined') {
                alert("The PDF processing library is still loading. Please try again in a few seconds.");
                return;
            }

            if (!file) return;

            // Validate File Type (Robust check)
            const isPdfType = file.type === 'application/pdf';
            const isPdfExt = file.name.toLowerCase().endsWith('.pdf');
            
            if (!isPdfType && !isPdfExt) {
                alert("Please upload a valid PDF file.");
                return;
            }

            currentFile = file;
            processFileName.textContent = file.name;
            
            // Switch Stage
            stageUpload.classList.remove('active');
            stageProcess.classList.add('active');
            
            // Start Repair
            startRepairProcess(file);
        }

        // --- 2. Repair Logic ---
        async function startRepairProcess(file) {
            // Reset Log
            statusLog.innerHTML = '';
            addLog("Initializing repair engine...");
            updateProgress(10, "Reading file stream...");

            try {
                // Read File
                const arrayBuffer = await file.arrayBuffer();
                addLog(`File size: ${formatBytes(arrayBuffer.byteLength)}`);
                
                updateProgress(30, "Analyzing PDF header...");
                await wait(800); 

                // Attempt to Load with PDF-Lib
                // This acts as a repair because saving it rewrites the XREF table
                addLog("Checking XREF table structure...");
                updateProgress(50, "Rebuilding object streams...");
                
                // We use ignoreEncryption to try and force load even if metadata is corrupt
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
                
                addLog("Structure analysis: Recoverable.");
                updateProgress(75, "Normalizing file structure...");
                addLog("Optimizing page tree...");
                
                await wait(800);
                
                // Save the "repaired" (regenerated) PDF
                const pdfBytes = await pdfDoc.save();
                
                finishSuccess(pdfBytes, "Structural Rebuild");

            } catch (error) {
                console.error(error);
                
                // If PDF-Lib crashes, the file is severely damaged
                addLog("Structural repair failed.", "error");
                addLog("Reason: " + error.message, "warn");
                
                updateProgress(100, "Failed");
                
                // Show specific error message in UI
                setTimeout(() => {
                    finishError("The file is too severely damaged to be repaired by this tool.");
                }, 1500);
            }
        }

        function finishSuccess(pdfBytes, method) {
            updateProgress(100, "Finalizing...");
            addLog(`Repair complete via: ${method}`);
            
            setTimeout(() => {
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                resultIconWrapper.innerHTML = '<i class="fas fa-check-circle result-icon success"></i>';
                resultTitle.textContent = "Repair Successful!";
                resultDesc.textContent = `We successfully rebuilt the file structure for "${currentFile.name}".`;
                
                downloadBtn.href = url;
                downloadBtn.download = `repaired_${currentFile.name}`;
                downloadBtn.style.display = 'inline-flex';

                stageProcess.classList.remove('active');
                stageResult.classList.add('active');
            }, 1000);
        }

        function finishError(msg) {
            resultIconWrapper.innerHTML = '<i class="fas fa-exclamation-circle result-icon error"></i>';
            resultTitle.textContent = "Repair Failed";
            resultDesc.textContent = msg;
            
            downloadBtn.style.display = 'none';

            stageProcess.classList.remove('active');
            stageResult.classList.add('active');
        }

        // --- Helpers ---
        function updateProgress(percent, text) {
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            if(text) progressText.textContent = text;
        }

        function addLog(text, type = "") {
            const div = document.createElement('div');
            div.className = `log-item ${type}`;
            div.textContent = `> ${text}`;
            statusLog.appendChild(div);
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

    </script>
</body>
</html>
