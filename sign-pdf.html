<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign PDF ‚Äì PassionTools</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --border: #e2e8f0;
  --header-bg: #ffffff;
  --footer-bg: #111827;
  --footer-text: #94a3b8;
  --drop-bg: #f1f5f9;
  --drop-border: #cbd5e1;
  --primary: #ef4444;
  --primary-hover: #dc2626;
  --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.08);
}

[data-theme="dark"] {
  --bg: #020617;
  --card: #111827;
  --text: #f8fafc;
  --muted: #94a3b8;
  --border: #1e293b;
  --header-bg: #0f172a;
  --footer-bg: #020617;
  --footer-text: #94a3b8;
  --drop-bg: #1e293b;
  --drop-border: #334155;
  --primary: #ef4444;
  --primary-hover: #dc2626;
  --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.2);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.3);
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.25s ease, color 0.25s ease;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  -webkit-font-smoothing: antialiased;
}

/* HEADER */
.header {
  position: sticky;
  top: 0;
  z-index: 1000;
  height: 70px;
  background: var(--header-bg);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  transition: background 0.25s ease, border-color 0.25s ease;
}

.logo {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: -0.5px;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0;
  user-select: none;
}

.logo-passion { color: var(--text); transition: color 0.25s ease; }
.logo-tools {
  background: linear-gradient(135deg, #ef4444, #a855f7);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.back-link {
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  text-decoration: none;
  white-space: nowrap;
  transition: color 0.25s ease;
}
.back-link:hover { color: var(--primary); }

.divider {
  width: 1px;
  height: 24px;
  background: var(--border);
  transition: background 0.25s ease;
}

.theme-toggle {
  background: none;
  border: 2px solid var(--border);
  border-radius: 10px;
  width: 40px;
  height: 40px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border-color 0.25s ease, background 0.25s ease;
  color: var(--text);
}
.theme-toggle:hover { border-color: var(--primary); background: var(--drop-bg); }

/* MAIN */
main {
  flex: 1;
  max-width: 1100px;
  width: 100%;
  margin: 0 auto;
  padding: 32px 20px;
}

.tool-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow);
  padding: 40px;
  transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
}

/* TOOL LOGO */
.tool-logo {
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
  animation: fadeInLogo 0.8s ease;
}
@keyframes fadeInLogo {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.tool-title {
  text-align: center;
  font-size: 28px;
  font-weight: 800;
  margin-bottom: 8px;
  letter-spacing: -0.5px;
}

.tool-subtitle {
  text-align: center;
  color: var(--muted);
  font-size: 15px;
  margin-bottom: 32px;
  line-height: 1.5;
}

/* UPLOAD AREA */
.upload-zone {
  background: var(--drop-bg);
  border: 2px dashed var(--drop-border);
  border-radius: 12px;
  padding: 48px 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
}
.upload-zone:hover, .upload-zone.drag-over {
  border-color: var(--primary);
  background: rgba(239, 68, 68, 0.04);
}
.upload-zone.drag-over { transform: scale(1.01); }

.upload-icon {
  width: 56px;
  height: 56px;
  margin: 0 auto 16px;
  color: var(--muted);
}

.upload-text { color: var(--muted); font-size: 15px; line-height: 1.6; }
.upload-text strong { color: var(--primary); }

.file-input { display: none; }

/* FILE INFO */
.file-info {
  display: none;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  background: var(--drop-bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-top: 16px;
  transition: all 0.25s ease;
}
.file-info.visible { display: flex; }

.file-icon {
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 11px;
  flex-shrink: 0;
}

.file-details { flex: 1; min-width: 0; }
.file-name {
  font-weight: 600;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.file-size { font-size: 13px; color: var(--muted); margin-top: 2px; }

.remove-file {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
.remove-file:hover { color: var(--primary); background: rgba(239,68,68,0.08); }

/* SIGNATURE PANEL */
.signature-panel {
  display: none;
  margin-top: 28px;
}
.signature-panel.visible { display: block; }

.section-label {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sig-tabs {
  display: flex;
  gap: 4px;
  background: var(--drop-bg);
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 20px;
}

.sig-tab {
  flex: 1;
  padding: 10px 16px;
  border: none;
  background: transparent;
  color: var(--muted);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s ease;
  font-family: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.sig-tab.active {
  background: var(--card);
  color: var(--text);
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.sig-tab:hover:not(.active) { color: var(--text); }

.sig-content { display: none; }
.sig-content.active { display: block; }

/* DRAW */
.draw-area {
  border: 2px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
  background: #ffffff;
}
[data-theme="dark"] .draw-area { background: #1e293b; }

#drawCanvas {
  display: block;
  width: 100%;
  height: 200px;
  cursor: crosshair;
  touch-action: none;
}

.draw-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  flex-wrap: wrap;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.control-label {
  font-size: 13px;
  color: var(--muted);
  font-weight: 500;
}

.color-input {
  width: 32px;
  height: 32px;
  border: 2px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  padding: 2px;
  background: var(--card);
}

.thickness-input {
  width: 80px;
  accent-color: var(--primary);
}

/* TYPE */
.type-area { padding: 4px 0; }

.type-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 16px;
  background: var(--card);
  color: var(--text);
  font-family: inherit;
  transition: border-color 0.2s ease;
  outline: none;
}
.type-input:focus { border-color: var(--primary); }

.type-controls {
  display: flex;
  gap: 12px;
  margin-top: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.font-select {
  padding: 8px 12px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  cursor: pointer;
  outline: none;
  font-family: inherit;
}
.font-select:focus { border-color: var(--primary); }

.type-preview {
  margin-top: 16px;
  padding: 24px;
  border: 2px solid var(--border);
  border-radius: 10px;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ffffff;
  transition: all 0.2s ease;
}
[data-theme="dark"] .type-preview { background: #1e293b; }

.type-preview-text {
  font-size: 32px;
  color: #0f172a;
  word-break: break-all;
}
[data-theme="dark"] .type-preview-text { color: #0f172a; }

/* UPLOAD SIG */
.upload-sig-zone {
  background: var(--drop-bg);
  border: 2px dashed var(--drop-border);
  border-radius: 10px;
  padding: 32px;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s ease;
}
.upload-sig-zone:hover { border-color: var(--primary); }

.sig-preview-container {
  display: none;
  margin-top: 16px;
  padding: 20px;
  border: 2px solid var(--border);
  border-radius: 10px;
  text-align: center;
  background: #ffffff;
}
[data-theme="dark"] .sig-preview-container { background: #1e293b; }
.sig-preview-container.visible { display: block; }
.sig-preview-container img {
  max-width: 300px;
  max-height: 120px;
}

.sig-upload-input { display: none; }

/* COMMON CONTROLS */
.common-controls {
  display: none;
  margin-top: 20px;
  padding: 20px;
  background: var(--drop-bg);
  border-radius: 10px;
  gap: 16px;
  flex-wrap: wrap;
  align-items: center;
}
.common-controls.visible { display: flex; }

.slider-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.slider-group label {
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
}
.slider-group input[type="range"] {
  width: 120px;
  accent-color: var(--primary);
}

/* PDF PREVIEW */
.pdf-preview-section {
  display: none;
  margin-top: 28px;
}
.pdf-preview-section.visible { display: block; }

.page-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  margin-bottom: 16px;
}

.page-btn {
  padding: 8px 16px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  color: var(--text);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}
.page-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
.page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.page-info { font-size: 14px; font-weight: 600; color: var(--muted); }

.preview-container {
  position: relative;
  border: 1px solid var(--border);
  border-radius: 10px;
  overflow: hidden;
  background: #e2e8f0;
  display: flex;
  justify-content: center;
  min-height: 300px;
}
[data-theme="dark"] .preview-container { background: #1e293b; }

.preview-wrapper {
  position: relative;
  display: inline-block;
}

#pdfCanvas {
  display: block;
  max-width: 100%;
  height: auto;
}

/* SIGNATURE OVERLAY */
.sig-overlay {
  position: absolute;
  cursor: move;
  border: 2px dashed var(--primary);
  background: rgba(239, 68, 68, 0.05);
  border-radius: 4px;
  display: none;
  touch-action: none;
  z-index: 10;
}
.sig-overlay.visible { display: block; }
.sig-overlay img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
  user-select: none;
}

.sig-resize {
  position: absolute;
  bottom: -5px;
  right: -5px;
  width: 14px;
  height: 14px;
  background: var(--primary);
  border-radius: 3px;
  cursor: nwse-resize;
  border: 2px solid white;
  z-index: 11;
}

.sig-remove-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  width: 22px;
  height: 22px;
  background: var(--primary);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  z-index: 12;
}

/* BUTTONS */
.action-buttons {
  display: none;
  gap: 12px;
  margin-top: 24px;
  flex-wrap: wrap;
}
.action-buttons.visible { display: flex; }

.btn-primary {
  flex: 1;
  min-width: 200px;
  padding: 14px 28px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  font-family: inherit;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: background 0.2s ease, transform 0.15s ease;
  box-shadow: 0 2px 8px rgba(239,68,68,0.25);
}
.btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-secondary {
  padding: 14px 28px;
  background: var(--drop-bg);
  color: var(--text);
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s ease;
}
.btn-secondary:hover { border-color: var(--primary); color: var(--primary); }

.btn-small {
  padding: 8px 16px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  color: var(--text);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s ease;
}
.btn-small:hover { border-color: var(--primary); color: var(--primary); }

.btn-clear {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  background: rgba(239,68,68,0.1);
  color: var(--primary);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s ease;
}
.btn-clear:hover { background: rgba(239,68,68,0.18); }

/* ADD SIG BUTTON */
.add-sig-btn {
  display: none;
  margin-top: 16px;
  padding: 10px 20px;
  border: 2px dashed var(--primary);
  border-radius: 10px;
  background: rgba(239,68,68,0.04);
  color: var(--primary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: all 0.2s ease;
  width: 100%;
  text-align: center;
}
.add-sig-btn.visible { display: block; }
.add-sig-btn:hover { background: rgba(239,68,68,0.1); }

/* PRIVACY */
.privacy-notice {
  margin-top: 24px;
  padding: 16px 20px;
  background: var(--drop-bg);
  border-radius: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--muted);
  line-height: 1.5;
  transition: background 0.25s ease;
}

/* TOAST */
.toast {
  position: fixed;
  bottom: 32px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: #10b981;
  color: white;
  padding: 14px 28px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  z-index: 9999;
  transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  white-space: nowrap;
}
.toast.visible { transform: translateX(-50%) translateY(0); }
.toast.error { background: var(--primary); }

/* FOOTER */
.footer {
  background: var(--footer-bg);
  padding: 24px;
  text-align: center;
  font-size: 14px;
  color: var(--footer-text);
  transition: background 0.25s ease;
  margin-top: auto;
}

/* LOADING */
.loading-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 5000;
  align-items: center;
  justify-content: center;
}
.loading-overlay.visible { display: flex; }

.loading-spinner {
  background: var(--card);
  padding: 32px 40px;
  border-radius: 12px;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--border);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-text { font-size: 14px; font-weight: 600; color: var(--text); }

/* RESPONSIVE */
@media (max-width: 768px) {
  .header { padding: 0 16px; }
  .back-link { font-size: 13px; }
  .tool-card { padding: 24px 16px; }
  .tool-title { font-size: 22px; }
  .upload-zone { padding: 32px 16px; }
  .draw-controls { gap: 8px; }
  .type-controls { flex-direction: column; align-items: stretch; }
  .common-controls { flex-direction: column; align-items: stretch; }
  .slider-group input[type="range"] { width: 100%; }
  .action-buttons { flex-direction: column; }
  .btn-primary, .btn-secondary { min-width: 100%; }
}

@media (max-width: 480px) {
  .header-right { gap: 10px; }
  .divider { display: none; }
  .tool-title { font-size: 20px; }
  .sig-tabs { gap: 2px; }
  .sig-tab { padding: 8px 10px; font-size: 13px; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <a href="index.html" class="logo" aria-label="PassionTools Home">
    <span class="logo-passion">Passion</span><span class="logo-tools">Tools</span>
  </a>
  <div class="header-right">
    <a href="index.html" class="back-link">‚Üê Back to Tools</a>
    <div class="divider"></div>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">üåô</button>
  </div>
</header>

<!-- MAIN -->
<main>
  <div class="tool-card">
    <!-- TOOL LOGO -->
    <div class="tool-logo">
      <svg width="90" height="90" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="logoShadow" x="-4" y="-2" width="98" height="98" filterUnits="userSpaceOnUse">
            <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.1"/>
          </filter>
        </defs>
        <g filter="url(#logoShadow)">
          <rect x="12" y="6" width="52" height="66" rx="6" fill="#ef4444"/>
          <rect x="16" y="10" width="44" height="58" rx="3" fill="white" opacity="0.95"/>
          <rect x="22" y="18" width="28" height="3" rx="1.5" fill="#ef4444" opacity="0.25"/>
          <rect x="22" y="25" width="32" height="3" rx="1.5" fill="#ef4444" opacity="0.2"/>
          <rect x="22" y="32" width="24" height="3" rx="1.5" fill="#ef4444" opacity="0.15"/>
          <rect x="22" y="39" width="30" height="3" rx="1.5" fill="#ef4444" opacity="0.12"/>
          <path d="M24 54 C28 48, 34 56, 38 50 C42 44, 46 58, 54 48" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" fill="none" opacity="0.9"/>
          <line x1="22" y1="60" x2="54" y2="60" stroke="#ef4444" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
        </g>
        <g transform="translate(48, 38) rotate(-30)">
          <rect x="0" y="0" width="10" height="42" rx="2" fill="#a855f7"/>
          <polygon points="2,42 8,42 5,50" fill="#64748b"/>
          <rect x="0" y="0" width="10" height="8" rx="2" fill="#9333ea"/>
          <circle cx="5" cy="47" r="1" fill="#0f172a" opacity="0.5"/>
        </g>
      </svg>
    </div>

    <h1 class="tool-title">Sign PDF</h1>
    <p class="tool-subtitle">Add electronic signatures to PDF documents directly in your browser. Secure, private, and completely client-side.</p>

    <!-- UPLOAD -->
    <div class="upload-zone" id="uploadZone">
      <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="12" y1="18" x2="12" y2="12"/>
        <polyline points="9 15 12 12 15 15"/>
      </svg>
      <div class="upload-text">
        <strong>Drop PDF here</strong> or click to upload<br>
        <span style="font-size:13px;">Maximum file size: 20MB</span>
      </div>
      <input type="file" class="file-input" id="fileInput" accept=".pdf,application/pdf">
    </div>

    <!-- FILE INFO -->
    <div class="file-info" id="fileInfo">
      <div class="file-icon">PDF</div>
      <div class="file-details">
        <div class="file-name" id="fileName"></div>
        <div class="file-size" id="fileSize"></div>
      </div>
      <button class="remove-file" id="removeFile" aria-label="Remove file">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>

    <!-- SIGNATURE PANEL -->
    <div class="signature-panel" id="sigPanel">
      <div class="section-label">‚úçÔ∏è Create Your Signature</div>

      <div class="sig-tabs">
        <button class="sig-tab active" data-tab="draw">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>
          Draw
        </button>
        <button class="sig-tab" data-tab="type">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
          Type
        </button>
        <button class="sig-tab" data-tab="upload">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Upload
        </button>
      </div>

      <!-- DRAW TAB -->
      <div class="sig-content active" id="tabDraw">
        <div class="draw-area">
          <canvas id="drawCanvas"></canvas>
          <div class="draw-controls">
            <div class="control-group">
              <span class="control-label">Color</span>
              <input type="color" class="color-input" id="drawColor" value="#0f172a">
            </div>
            <div class="control-group">
              <span class="control-label">Thickness</span>
              <input type="range" class="thickness-input" id="drawThickness" min="1" max="8" value="3">
            </div>
            <div style="margin-left:auto;">
              <button class="btn-clear" id="clearDraw">Clear</button>
            </div>
          </div>
        </div>
        <button class="btn-small" id="useDraw" style="margin-top:12px;">Use This Signature</button>
      </div>

      <!-- TYPE TAB -->
      <div class="sig-content" id="tabType">
        <div class="type-area">
          <input type="text" class="type-input" id="typeInput" placeholder="Type your signature..." maxlength="60">
          <div class="type-controls">
            <div class="control-group">
              <span class="control-label">Font</span>
              <select class="font-select" id="fontSelect">
                <option value="'Dancing Script', cursive">Dancing Script</option>
                <option value="'Great Vibes', cursive">Great Vibes</option>
                <option value="'Pacifico', cursive">Pacifico</option>
                <option value="'Caveat', cursive">Caveat</option>
                <option value="'Sacramento', cursive">Sacramento</option>
                <option value="Georgia, serif">Georgia</option>
              </select>
            </div>
            <div class="control-group">
              <span class="control-label">Size</span>
              <input type="range" id="fontSize" min="20" max="60" value="36" style="width:100px;accent-color:var(--primary);">
            </div>
            <div class="control-group">
              <span class="control-label">Color</span>
              <input type="color" class="color-input" id="typeColor" value="#0f172a">
            </div>
          </div>
          <div class="type-preview" id="typePreview">
            <span class="type-preview-text" id="typePreviewText" style="font-family:'Dancing Script',cursive;">Your signature</span>
          </div>
        </div>
        <button class="btn-small" id="useType" style="margin-top:12px;">Use This Signature</button>
      </div>

      <!-- UPLOAD TAB -->
      <div class="sig-content" id="tabUpload">
        <div class="upload-sig-zone" id="uploadSigZone">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" style="color:var(--muted);margin-bottom:8px;">
            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
          </svg>
          <div class="upload-text" style="margin-top:8px;">
            <strong>Upload signature image</strong><br>
            <span style="font-size:13px;">PNG or JPG (transparent background recommended)</span>
          </div>
          <input type="file" class="sig-upload-input" id="sigUploadInput" accept="image/png,image/jpeg,image/jpg">
        </div>
        <div class="sig-preview-container" id="sigUploadPreview">
          <img id="sigUploadImg" alt="Uploaded signature">
          <div style="margin-top:12px;">
            <button class="btn-small" id="useUpload">Use This Signature</button>
            <button class="btn-clear" id="removeSigUpload" style="margin-left:8px;">Remove</button>
          </div>
        </div>
      </div>

      <!-- COMMON CONTROLS -->
      <div class="common-controls" id="commonControls">
        <div class="slider-group">
          <label>Opacity</label>
          <input type="range" id="sigOpacity" min="20" max="100" value="100">
        </div>
        <div class="slider-group">
          <label>Signature Size</label>
          <input type="range" id="sigScale" min="30" max="200" value="100">
        </div>
        <div style="margin-left:auto;">
          <span style="font-size:13px;color:var(--muted);">Drag signature on preview to position</span>
        </div>
      </div>
    </div>

    <!-- PDF PREVIEW -->
    <div class="pdf-preview-section" id="pdfPreviewSection">
      <div class="section-label">üìÑ Preview & Position Signature</div>
      <div class="page-nav">
        <button class="page-btn" id="prevPage" disabled>‚Äπ Prev</button>
        <span class="page-info" id="pageInfo">Page 1 / 1</span>
        <button class="page-btn" id="nextPage" disabled>Next ‚Ä∫</button>
      </div>
      <div class="preview-container" id="previewContainer">
        <div class="preview-wrapper" id="previewWrapper">
          <canvas id="pdfCanvas"></canvas>
          <div class="sig-overlay" id="sigOverlay">
            <img id="sigOverlayImg" alt="Signature">
            <div class="sig-resize" id="sigResize"></div>
            <button class="sig-remove-btn" id="sigRemoveBtn">√ó</button>
          </div>
        </div>
      </div>
      <button class="add-sig-btn" id="addSigBtn">+ Place Signature on This Page</button>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="action-buttons" id="actionButtons">
      <button class="btn-primary" id="signBtn" disabled>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Sign & Download PDF
      </button>
      <button class="btn-secondary" id="resetBtn">Reset</button>
    </div>

    <!-- PRIVACY -->
    <div class="privacy-notice">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="flex-shrink:0;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      This tool processes your PDF entirely in your browser. No files are uploaded or stored. Your documents remain private.
    </div>
  </div>
</main>

<!-- FOOTER -->
<footer class="footer">¬© 2026 Passion Tools. Secure client-side processing.</footer>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Processing...</div>
  </div>
</div>

<!-- GOOGLE FONTS FOR SIGNATURES -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Pacifico&family=Sacramento&display=swap" rel="stylesheet">

<script>
(() => {
  'use strict';

  // ====== THEME ======
  const themeToggle = document.getElementById('themeToggle');
  const root = document.documentElement;

  function getPreferredTheme() {
    const saved = localStorage.getItem('pt-theme');
    if (saved) return saved;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    root.setAttribute('data-theme', theme);
    themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('pt-theme', theme);
  }

  applyTheme(getPreferredTheme());

  themeToggle.addEventListener('click', () => {
    const current = root.getAttribute('data-theme');
    applyTheme(current === 'dark' ? 'light' : 'dark');
  });

  // ====== GLOBALS ======
  const MAX_FILE_SIZE = 20 * 1024 * 1024;
  let pdfDoc = null;
  let pdfBytes = null;
  let currentPage = 1;
  let totalPages = 0;
  let signatureDataURL = null;
  let sigPlacements = {}; // { pageNum: { x, y, w, h } } relative to canvas

  // ====== ELEMENTS ======
  const uploadZone = document.getElementById('uploadZone');
  const fileInput = document.getElementById('fileInput');
  const fileInfo = document.getElementById('fileInfo');
  const fileName = document.getElementById('fileName');
  const fileSize = document.getElementById('fileSize');
  const removeFile = document.getElementById('removeFile');
  const sigPanel = document.getElementById('sigPanel');
  const pdfPreviewSection = document.getElementById('pdfPreviewSection');
  const actionButtons = document.getElementById('actionButtons');
  const signBtn = document.getElementById('signBtn');
  const resetBtn = document.getElementById('resetBtn');
  const pdfCanvas = document.getElementById('pdfCanvas');
  const pdfCtx = pdfCanvas.getContext('2d');
  const previewWrapper = document.getElementById('previewWrapper');
  const previewContainer = document.getElementById('previewContainer');
  const sigOverlay = document.getElementById('sigOverlay');
  const sigOverlayImg = document.getElementById('sigOverlayImg');
  const sigResize = document.getElementById('sigResize');
  const sigRemoveBtn = document.getElementById('sigRemoveBtn');
  const addSigBtn = document.getElementById('addSigBtn');
  const commonControls = document.getElementById('commonControls');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const pageInfoEl = document.getElementById('pageInfo');
  const toast = document.getElementById('toast');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');

  // Signature controls
  const sigOpacity = document.getElementById('sigOpacity');
  const sigScale = document.getElementById('sigScale');

  // ====== TOAST ======
  function showToast(msg, isError = false) {
    toast.textContent = msg;
    toast.className = 'toast' + (isError ? ' error' : '');
    requestAnimationFrame(() => toast.classList.add('visible'));
    setTimeout(() => toast.classList.remove('visible'), 3000);
  }

  // ====== LOADING ======
  function showLoading(msg = 'Processing...') {
    loadingText.textContent = msg;
    loadingOverlay.classList.add('visible');
  }
  function hideLoading() {
    loadingOverlay.classList.remove('visible');
  }

  // ====== FORMAT FILE SIZE ======
  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(2) + ' MB';
  }

  // ====== FILE UPLOAD ======
  uploadZone.addEventListener('click', () => fileInput.click());

  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
  });
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
  });
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) handleFile(file);
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  removeFile.addEventListener('click', resetAll);

  async function handleFile(file) {
    if (!file.type.includes('pdf') && !file.name.toLowerCase().endsWith('.pdf')) {
      showToast('Please select a PDF file.', true);
      return;
    }
    if (file.size > MAX_FILE_SIZE) {
      showToast('File exceeds 20MB limit.', true);
      return;
    }

    fileName.textContent = file.name;
    fileSize.textContent = formatSize(file.size);
    fileInfo.classList.add('visible');
    uploadZone.style.display = 'none';

    try {
      showLoading('Loading PDF...');
      const arrayBuffer = await file.arrayBuffer();
      pdfBytes = new Uint8Array(arrayBuffer);

      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes.slice() }).promise;
      totalPages = pdfDoc.numPages;
      currentPage = 1;

      sigPanel.classList.add('visible');
      pdfPreviewSection.classList.add('visible');
      actionButtons.classList.add('visible');

      await renderPage(currentPage);
      updatePageNav();
      hideLoading();
    } catch (err) {
      hideLoading();
      console.error(err);
      showToast('Unable to load PDF. The file may be encrypted or corrupted.', true);
      resetAll();
    }
  }

  // ====== PDF RENDERING ======
  async function renderPage(num) {
    try {
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: 1.5 });

      const containerWidth = previewContainer.clientWidth - 4;
      const scale = Math.min(containerWidth / viewport.width, 1.5);
      const scaledViewport = page.getViewport({ scale: scale });

      pdfCanvas.width = scaledViewport.width;
      pdfCanvas.height = scaledViewport.height;

      await page.render({ canvasContext: pdfCtx, viewport: scaledViewport }).promise;

      // Update signature overlay for this page
      updateSigOverlayForPage(num);
    } catch (err) {
      console.error(err);
      showToast('Error rendering page.', true);
    }
  }

  function updatePageNav() {
    pageInfoEl.textContent = `Page ${currentPage} / ${totalPages}`;
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
  }

  prevPageBtn.addEventListener('click', async () => {
    if (currentPage > 1) {
      saveSigPosition();
      currentPage--;
      await renderPage(currentPage);
      updatePageNav();
    }
  });

  nextPageBtn.addEventListener('click', async () => {
    if (currentPage < totalPages) {
      saveSigPosition();
      currentPage++;
      await renderPage(currentPage);
      updatePageNav();
    }
  });

  // ====== SIGNATURE TABS ======
  const sigTabs = document.querySelectorAll('.sig-tab');
  const sigContents = document.querySelectorAll('.sig-content');

  sigTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      sigTabs.forEach(t => t.classList.remove('active'));
      sigContents.forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('tab' + capitalize(tab.dataset.tab)).classList.add('active');
    });
  });

  function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

  // ====== DRAW CANVAS ======
  const drawCanvas = document.getElementById('drawCanvas');
  const drawCtx = drawCanvas.getContext('2d');
  const drawColor = document.getElementById('drawColor');
  const drawThickness = document.getElementById('drawThickness');
  const clearDraw = document.getElementById('clearDraw');
  let isDrawing = false;
  let lastX = 0, lastY = 0;

  function initDrawCanvas() {
    const rect = drawCanvas.getBoundingClientRect();
    drawCanvas.width = rect.width * 2;
    drawCanvas.height = 400;
    drawCanvas.style.height = '200px';
    drawCtx.scale(2, 2);
    drawCtx.lineCap = 'round';
    drawCtx.lineJoin = 'round';
  }

  function getDrawPos(e) {
    const rect = drawCanvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  }

  drawCanvas.addEventListener('mousedown', (e) => {
    isDrawing = true;
    const pos = getDrawPos(e);
    lastX = pos.x; lastY = pos.y;
  });
  drawCanvas.addEventListener('mousemove', (e) => {
    if (!isDrawing) return;
    const pos = getDrawPos(e);
    drawCtx.strokeStyle = drawColor.value;
    drawCtx.lineWidth = parseInt(drawThickness.value);
    drawCtx.beginPath();
    drawCtx.moveTo(lastX, lastY);
    drawCtx.lineTo(pos.x, pos.y);
    drawCtx.stroke();
    lastX = pos.x; lastY = pos.y;
  });
  drawCanvas.addEventListener('mouseup', () => isDrawing = false);
  drawCanvas.addEventListener('mouseleave', () => isDrawing = false);

  drawCanvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    isDrawing = true;
    const pos = getDrawPos(e);
    lastX = pos.x; lastY = pos.y;
  }, { passive: false });
  drawCanvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!isDrawing) return;
    const pos = getDrawPos(e);
    drawCtx.strokeStyle = drawColor.value;
    drawCtx.lineWidth = parseInt(drawThickness.value);
    drawCtx.beginPath();
    drawCtx.moveTo(lastX, lastY);
    drawCtx.lineTo(pos.x, pos.y);
    drawCtx.stroke();
    lastX = pos.x; lastY = pos.y;
  }, { passive: false });
  drawCanvas.addEventListener('touchend', () => isDrawing = false);

  clearDraw.addEventListener('click', () => {
    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
  });

  document.getElementById('useDraw').addEventListener('click', () => {
    const tempCanvas = document.createElement('canvas');
    const ctx = tempCanvas.getContext('2d');
    tempCanvas.width = drawCanvas.width;
    tempCanvas.height = drawCanvas.height;
    ctx.drawImage(drawCanvas, 0, 0);

    // Trim whitespace
    const trimmed = trimCanvas(tempCanvas);
    if (!trimmed) {
      showToast('Please draw a signature first.', true);
      return;
    }
    signatureDataURL = trimmed.toDataURL('image/png');
    activateSignature();
    showToast('Signature created!');
  });

  // ====== TRIM CANVAS ======
  function trimCanvas(canvas) {
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const imageData = ctx.getImageData(0, 0, w, h);
    const data = imageData.data;
    let top = h, left = w, right = 0, bottom = 0;
    let found = false;

    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        const idx = (y * w + x) * 4;
        if (data[idx + 3] > 10) {
          found = true;
          if (y < top) top = y;
          if (y > bottom) bottom = y;
          if (x < left) left = x;
          if (x > right) right = x;
        }
      }
    }

    if (!found) return null;

    const pad = 20;
    top = Math.max(0, top - pad);
    left = Math.max(0, left - pad);
    right = Math.min(w - 1, right + pad);
    bottom = Math.min(h - 1, bottom + pad);

    const trimW = right - left + 1;
    const trimH = bottom - top + 1;
    const trimmed = document.createElement('canvas');
    trimmed.width = trimW;
    trimmed.height = trimH;
    trimmed.getContext('2d').drawImage(canvas, left, top, trimW, trimH, 0, 0, trimW, trimH);
    return trimmed;
  }

  // ====== TYPE SIGNATURE ======
  const typeInput = document.getElementById('typeInput');
  const fontSelect = document.getElementById('fontSelect');
  const fontSizeInput = document.getElementById('fontSize');
  const typeColor = document.getElementById('typeColor');
  const typePreviewText = document.getElementById('typePreviewText');

  function updateTypePreview() {
    const text = typeInput.value || 'Your signature';
    typePreviewText.textContent = text;
    typePreviewText.style.fontFamily = fontSelect.value;
    typePreviewText.style.fontSize = fontSizeInput.value + 'px';
    typePreviewText.style.color = typeColor.value;
  }

  typeInput.addEventListener('input', updateTypePreview);
  fontSelect.addEventListener('change', updateTypePreview);
  fontSizeInput.addEventListener('input', updateTypePreview);
  typeColor.addEventListener('input', updateTypePreview);

  document.getElementById('useType').addEventListener('click', () => {
    const text = typeInput.value.trim();
    if (!text) {
      showToast('Please type a signature first.', true);
      return;
    }

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = parseInt(fontSizeInput.value) * 2;
    const font = fontSelect.value;

    ctx.font = `${size}px ${font.replace(/'/g, '')}`;
    const metrics = ctx.measureText(text);
    const textWidth = metrics.width + 40;
    const textHeight = size * 1.6;

    canvas.width = textWidth;
    canvas.height = textHeight;
    ctx.font = `${size}px ${font.replace(/'/g, '')}`;
    ctx.fillStyle = typeColor.value;
    ctx.textBaseline = 'middle';
    ctx.fillText(text, 20, textHeight / 2);

    const trimmed = trimCanvas(canvas);
    signatureDataURL = (trimmed || canvas).toDataURL('image/png');
    activateSignature();
    showToast('Signature created!');
  });

  // ====== UPLOAD SIGNATURE ======
  const uploadSigZone = document.getElementById('uploadSigZone');
  const sigUploadInput = document.getElementById('sigUploadInput');
  const sigUploadPreview = document.getElementById('sigUploadPreview');
  const sigUploadImg = document.getElementById('sigUploadImg');

  uploadSigZone.addEventListener('click', () => sigUploadInput.click());
  sigUploadInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      showToast('Please select an image file.', true);
      return;
    }
    const reader = new FileReader();
    reader.onload = (ev) => {
      sigUploadImg.src = ev.target.result;
      sigUploadPreview.classList.add('visible');
      uploadSigZone.style.display = 'none';
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('useUpload').addEventListener('click', () => {
    signatureDataURL = sigUploadImg.src;
    activateSignature();
    showToast('Signature uploaded!');
  });

  document.getElementById('removeSigUpload').addEventListener('click', () => {
    sigUploadPreview.classList.remove('visible');
    uploadSigZone.style.display = '';
    sigUploadInput.value = '';
  });

  // ====== ACTIVATE SIGNATURE ======
  function activateSignature() {
    commonControls.classList.add('visible');
    addSigBtn.classList.add('visible');
    signBtn.disabled = false;

    // Auto-place on current page
    placeSigOnPage(currentPage);
  }

  function placeSigOnPage(pageNum) {
    sigOverlayImg.src = signatureDataURL;
    sigOverlay.classList.add('visible');

    const canvasW = pdfCanvas.width / (window.devicePixelRatio || 1);
    const canvasH = pdfCanvas.height / (window.devicePixelRatio || 1);

    const existing = sigPlacements[pageNum];
    if (existing) {
      sigOverlay.style.left = existing.x + 'px';
      sigOverlay.style.top = existing.y + 'px';
      sigOverlay.style.width = existing.w + 'px';
      sigOverlay.style.height = existing.h + 'px';
    } else {
      const sw = Math.min(180, pdfCanvas.clientWidth * 0.3);
      const sh = sw * 0.4;
      const sx = (pdfCanvas.clientWidth - sw) / 2;
      const sy = pdfCanvas.clientHeight - sh - 40;
      sigOverlay.style.left = sx + 'px';
      sigOverlay.style.top = sy + 'px';
      sigOverlay.style.width = sw + 'px';
      sigOverlay.style.height = sh + 'px';
      sigPlacements[pageNum] = { x: sx, y: sy, w: sw, h: sh };
    }

    updateSigStyle();
  }

  function updateSigOverlayForPage(pageNum) {
    if (!signatureDataURL) {
      sigOverlay.classList.remove('visible');
      return;
    }
    if (sigPlacements[pageNum]) {
      sigOverlayImg.src = signatureDataURL;
      sigOverlay.classList.add('visible');
      const p = sigPlacements[pageNum];
      sigOverlay.style.left = p.x + 'px';
      sigOverlay.style.top = p.y + 'px';
      sigOverlay.style.width = p.w + 'px';
      sigOverlay.style.height = p.h + 'px';
      updateSigStyle();
    } else {
      sigOverlay.classList.remove('visible');
    }
  }

  function saveSigPosition() {
    if (!sigOverlay.classList.contains('visible')) return;
    sigPlacements[currentPage] = {
      x: parseFloat(sigOverlay.style.left) || 0,
      y: parseFloat(sigOverlay.style.top) || 0,
      w: parseFloat(sigOverlay.style.width) || 150,
      h: parseFloat(sigOverlay.style.height) || 60
    };
  }

  function updateSigStyle() {
    const opacity = sigOpacity.value / 100;
    sigOverlay.style.opacity = opacity;

    const scale = sigScale.value / 100;
    const baseW = 180;
    const baseH = 72;
    const newW = baseW * scale;
    const newH = baseH * scale;

    // Only update size from scale if no existing placement
    // sigOverlay.style.width = newW + 'px';
    // sigOverlay.style.height = newH + 'px';
  }

  sigOpacity.addEventListener('input', () => {
    sigOverlay.style.opacity = sigOpacity.value / 100;
  });

  sigScale.addEventListener('input', () => {
    if (!sigOverlay.classList.contains('visible')) return;
    const scale = sigScale.value / 100;
    const p = sigPlacements[currentPage];
    if (!p) return;
    const baseW = p.w || 180;
    const baseH = p.h || 72;
    // Scale relative
    const newW = 180 * scale;
    const newH = 72 * scale;
    sigOverlay.style.width = newW + 'px';
    sigOverlay.style.height = newH + 'px';
    sigPlacements[currentPage].w = newW;
    sigPlacements[currentPage].h = newH;
  });

  addSigBtn.addEventListener('click', () => {
    if (!signatureDataURL) {
      showToast('Create a signature first.', true);
      return;
    }
    placeSigOnPage(currentPage);
    showToast(`Signature placed on page ${currentPage}`);
  });

  sigRemoveBtn.addEventListener('click', () => {
    sigOverlay.classList.remove('visible');
    delete sigPlacements[currentPage];
  });

  // ====== DRAG SIGNATURE ======
  let isDragging = false;
  let isResizing = false;
  let dragStartX, dragStartY, dragOffsetX, dragOffsetY;
  let resizeStartX, resizeStartY, resizeStartW, resizeStartH;

  sigOverlay.addEventListener('mousedown', startDrag);
  sigOverlay.addEventListener('touchstart', startDrag, { passive: false });

  function startDrag(e) {
    if (e.target === sigResize) return;
    if (e.target === sigRemoveBtn) return;
    e.preventDefault();
    isDragging = true;
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const rect = sigOverlay.getBoundingClientRect();
    dragOffsetX = clientX - rect.left;
    dragOffsetY = clientY - rect.top;
  }

  document.addEventListener('mousemove', onDrag);
  document.addEventListener('touchmove', onDrag, { passive: false });

  function onDrag(e) {
    if (isDragging) {
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const parentRect = previewWrapper.getBoundingClientRect();
      let x = clientX - parentRect.left - dragOffsetX;
      let y = clientY - parentRect.top - dragOffsetY;

      const maxX = pdfCanvas.clientWidth - sigOverlay.offsetWidth;
      const maxY = pdfCanvas.clientHeight - sigOverlay.offsetHeight;
      x = Math.max(0, Math.min(x, maxX));
      y = Math.max(0, Math.min(y, maxY));

      sigOverlay.style.left = x + 'px';
      sigOverlay.style.top = y + 'px';
      sigPlacements[currentPage] = {
        x, y,
        w: sigOverlay.offsetWidth,
        h: sigOverlay.offsetHeight
      };
    }
    if (isResizing) {
      e.preventDefault();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const dx = clientX - resizeStartX;
      const dy = clientY - resizeStartY;
      const newW = Math.max(50, resizeStartW + dx);
      const newH = Math.max(20, resizeStartH + dy);

      sigOverlay.style.width = newW + 'px';
      sigOverlay.style.height = newH + 'px';
      sigPlacements[currentPage] = {
        x: parseFloat(sigOverlay.style.left),
        y: parseFloat(sigOverlay.style.top),
        w: newW,
        h: newH
      };
    }
  }

  document.addEventListener('mouseup', stopDragResize);
  document.addEventListener('touchend', stopDragResize);

  function stopDragResize() {
    isDragging = false;
    isResizing = false;
  }

  sigResize.addEventListener('mousedown', startResize);
  sigResize.addEventListener('touchstart', startResize, { passive: false });

  function startResize(e) {
    e.preventDefault();
    e.stopPropagation();
    isResizing = true;
    resizeStartX = e.touches ? e.touches[0].clientX : e.clientX;
    resizeStartY = e.touches ? e.touches[0].clientY : e.clientY;
    resizeStartW = sigOverlay.offsetWidth;
    resizeStartH = sigOverlay.offsetHeight;
  }

  // ====== SIGN & DOWNLOAD ======
  signBtn.addEventListener('click', async () => {
    if (!pdfBytes || !signatureDataURL) {
      showToast('Please upload a PDF and create a signature.', true);
      return;
    }

    saveSigPosition();

    const pages = Object.keys(sigPlacements);
    if (pages.length === 0) {
      showToast('Please place your signature on at least one page.', true);
      return;
    }

    try {
      showLoading('Signing PDF...');

      const pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });

      // Convert signature to PNG bytes
      const sigResponse = await fetch(signatureDataURL);
      const sigBytes = await sigResponse.arrayBuffer();

      let sigImage;
      if (signatureDataURL.includes('image/png')) {
        sigImage = await pdfLibDoc.embedPng(sigBytes);
      } else {
        sigImage = await pdfLibDoc.embedJpg(sigBytes);
      }

      const pdfPages = pdfLibDoc.getPages();
      const opacity = parseFloat(sigOpacity.value) / 100;

      for (const pageNumStr of pages) {
        const pageNum = parseInt(pageNumStr);
        const placement = sigPlacements[pageNum];
        const page = pdfPages[pageNum - 1];

        if (!page) continue;

        const pageWidth = page.getWidth();
        const pageHeight = page.getHeight();

        // Convert from canvas coordinates to PDF coordinates
        const canvasW = pdfCanvas.clientWidth;
        const canvasH = pdfCanvas.clientHeight;

        const scaleX = pageWidth / canvasW;
        const scaleY = pageHeight / canvasH;

        const sigX = placement.x * scaleX;
        const sigW = placement.w * scaleX;
        const sigH = placement.h * scaleY;
        // PDF coordinates are from bottom-left
        const sigY = pageHeight - (placement.y * scaleY) - sigH;

        page.drawImage(sigImage, {
          x: sigX,
          y: sigY,
          width: sigW,
          height: sigH,
          opacity: opacity
        });
      }

      const signedPdfBytes = await pdfLibDoc.save();
      const blob = new Blob([signedPdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'signed-document.pdf';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      hideLoading();
      showToast('PDF signed and downloaded successfully!');
    } catch (err) {
      hideLoading();
      console.error(err);
      showToast('Unable to apply signature. Please try another file.', true);
    }
  });

  // ====== RESET ======
  resetBtn.addEventListener('click', resetAll);

  function resetAll() {
    pdfDoc = null;
    pdfBytes = null;
    currentPage = 1;
    totalPages = 0;
    signatureDataURL = null;
    sigPlacements = {};

    fileInput.value = '';
    fileInfo.classList.remove('visible');
    uploadZone.style.display = '';
    sigPanel.classList.remove('visible');
    pdfPreviewSection.classList.remove('visible');
    actionButtons.classList.remove('visible');
    commonControls.classList.remove('visible');
    addSigBtn.classList.remove('visible');
    sigOverlay.classList.remove('visible');
    signBtn.disabled = true;

    // Clear draw canvas
    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);

    // Clear type
    typeInput.value = '';
    updateTypePreview();

    // Clear upload sig
    sigUploadPreview.classList.remove('visible');
    uploadSigZone.style.display = '';
    sigUploadInput.value = '';

    // Reset sliders
    sigOpacity.value = 100;
    sigScale.value = 100;

    // Clear PDF canvas
    pdfCtx.clearRect(0, 0, pdfCanvas.width, pdfCanvas.height);
  }

  // ====== INIT ======
  window.addEventListener('load', () => {
    initDrawCanvas();
  });

  window.addEventListener('resize', () => {
    initDrawCanvas();
  });

})();
</script>

</body>
</html>
