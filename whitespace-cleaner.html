<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whitespace Cleaner – Smart Text Formatter | PassionTools</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Brand Colors */
            --brand-charcoal: #1f2937;
            --brand-red: #ef4444;
            --brand-purple: #a855f7;
            --brand-gradient: linear-gradient(135deg, #ef4444, #a855f7);
            --midnight-black: #0f172a;
            
            /* Light Theme UI */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-soft: #f1f5f9;
            --border-color: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            
            /* Accents */
            --primary-blue: #3b82f6;
            --primary-blue-hover: #2563eb;
            --accent-green: #10b981;    
            --accent-green-glow: rgba(16, 185, 129, 0.3);
            --accent-red: #ef4444;      
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
            --accent-teal: #14b8a6;
            
            /* Structure */
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg-body: #020617;
            --bg-card: #0f172a;
            --bg-soft: #1e293b;
            --border-color: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.5);
            --midnight-black: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; transition: var(--transition); }

        /* --- HEADER --- */
        header { background-color: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 16px 0; position: sticky; top: 0; z-index: 100; transition: var(--transition); box-shadow: var(--shadow-sm); }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; height: 70px; }
        
        .logo { font-size: 24px; font-weight: 800; text-decoration: none; color: var(--text-main); letter-spacing: -0.5px; }
        .logo span { background: var(--brand-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .header-actions { display: flex; align-items: center; gap: 16px; }
        .back-link { text-decoration: none; color: var(--text-muted); font-size: 15px; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .back-link:hover { color: var(--brand-red); opacity: 0.9; transform: translateX(-2px); }
        
        .header-divider { width: 1px; height: 20px; background-color: var(--border-color); }
        .theme-toggle { background: transparent; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; display: flex; align-items: center; transition: var(--transition); }
        .theme-toggle:hover { transform: scale(1.1); color: var(--text-main); }
        [data-theme="dark"] .theme-toggle { color: #fbbf24; }

        /* --- MAIN LAYOUT --- */
        main { flex: 1; padding: 40px 0; display: flex; flex-direction: column; align-items: center; width: 100%; }
        .hero-title { text-align: center; margin-bottom: 30px; padding: 0 20px; animation: fadeUp 0.4s ease; }
        .hero-title h1 { font-size: 32px; font-weight: 800; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 12px; }
        .hero-title h1 i { color: var(--primary-blue); }
        .hero-title p { color: var(--text-muted); font-size: 16px; max-width: 600px; margin: 0 auto; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            width: 100%;
            animation: fadeUp 0.5s ease;
        }

        @media (min-width: 1024px) {
            .dashboard-grid { grid-template-columns: 350px 1fr 1fr; }
        }

        /* --- CARDS --- */
        .card { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-md); 
            border: 1px solid var(--border-color); 
            padding: 24px; 
            transition: var(--transition); 
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-group { display: flex; gap: 8px; flex-wrap: wrap; }

        .icon-btn {
            background: var(--bg-soft);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
        }

        .icon-btn:hover { background: var(--bg-card); border-color: var(--primary-blue); color: var(--primary-blue); }
        .icon-btn.danger:hover { border-color: var(--brand-red); color: var(--brand-red); }
        .icon-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color) !important; color: var(--text-muted) !important; }

        /* --- TEXTAREAS & PREVIEW --- */
        .editor-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 400px;
        }

        textarea, .diff-preview {
            width: 100%;
            flex: 1;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-soft);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            transition: var(--transition);
            white-space: pre-wrap;
            overflow-y: auto;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }

        textarea:focus {
            border-color: var(--primary-blue);
            background: var(--bg-card);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        textarea[readonly] { cursor: default; }

        /* Diff Preview Overlays */
        .diff-preview {
            background: var(--bg-card);
            border-color: var(--accent-orange);
            display: none;
            z-index: 10;
        }
        .diff-preview.active { display: block; }
        
        /* Removed space highlighting */
        .removed-space { background-color: rgba(239, 68, 68, 0.2); text-decoration: line-through; color: var(--brand-red); }
        .removed-newline { background-color: rgba(239, 68, 68, 0.2); color: var(--brand-red); display: inline-block; width: 100%; text-align: right;}
        .removed-newline::after { content: "↵"; font-size: 10px; margin-left: 4px; }

        .editor-status {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0 4px;
            flex-wrap: wrap;
        }

        .stats-badge {
            background: var(--bg-soft);
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-badge.highlight { color: var(--primary-blue); border-color: rgba(59, 130, 246, 0.3); background: rgba(59, 130, 246, 0.05); }

        /* --- SETTINGS PANEL (Left Sidebar) --- */
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .settings-group {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .group-title {
            background: var(--bg-soft);
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .group-content {
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .option-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-main);
            line-height: 1.4;
            flex: 1;
        }

        /* Checkbox Switch */
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary-blue); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Custom Input */
        .custom-input {
            width: 60px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            outline: none;
            transition: var(--transition);
        }
        .custom-input:focus { border-color: var(--primary-blue); }
        .custom-input:disabled { opacity: 0.5; background: var(--bg-soft); }

        /* Action Buttons */
        .primary-actions { margin-top: 24px; display: flex; flex-direction: column; gap: 12px;}

        .btn-process {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-hover));
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-process:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4); }

        /* --- OUTPUT PANEL ACCENTS --- */
        .summary-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .summary-box {
            background: var(--bg-soft);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 12px;
            text-align: center;
        }

        .summary-val { font-size: 20px; font-weight: 700; color: var(--accent-red); font-family: 'JetBrains Mono', monospace; line-height: 1; margin-bottom: 4px;}
        .summary-label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }

        .proc-time { font-size: 12px; color: var(--text-muted); margin-top: 16px; text-align: right; font-family: 'JetBrains Mono', monospace; }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--text-main); color: var(--bg-card); padding: 14px 28px;
            border-radius: 30px; font-weight: 600; font-size: 14px;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: var(--transition); opacity: 0; z-index: 2000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast i { font-size: 16px; }
        .toast.success i { color: var(--accent-green); }
        .toast.error i { color: var(--brand-red); }
        .toast.info i { color: var(--primary-blue); }

        /* --- FOOTER --- */
        footer { background-color: var(--midnight-black); color: #ffffff; padding: 40px 0; text-align: center; font-size: 14px; margin-top: auto; transition: var(--transition); }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .card-header { flex-wrap: wrap; gap: 12px; }
            .toolbar-group { width: 100%; justify-content: space-between; }
            .summary-dashboard { grid-template-columns: repeat(2, 1fr); }
            textarea, .diff-preview { min-height: 250px; }
        }
        @media (max-width: 480px) {
            .card { border-radius: 0; border-left: none; border-right: none; padding: 20px; }
            main { padding: 20px 0; }
        }
    </style>
</head>
<body data-theme="light">

    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">Passion<span>Tools</span></a>
                <div class="header-actions">
                    <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Tools</a>
                    <div class="header-divider"></div>
                    <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
                        <i class="far fa-lightbulb"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="hero-title">
                <h1><i class="fas fa-broom"></i> Whitespace Cleaner</h1>
                <p>Smart text formatter to remove unwanted spaces, line breaks, and invisible characters instantly.</p>
            </div>

            <div class="dashboard-grid">
                
                <div class="card" style="height: fit-content;">
                    <div class="card-header" style="border-bottom: none; padding-bottom: 0;">
                        <div class="card-title"><i class="fas fa-sliders-h"></i> Cleaning Rules</div>
                    </div>

                    <div class="settings-list">
                        
                        <div class="settings-group">
                            <div class="group-title"><i class="fas fa-arrows-alt-h"></i> Space Settings</div>
                            <div class="group-content">
                                <div class="option-item">
                                    <span class="option-label">Remove Extra Spaces Between Words (Compress)</span>
                                    <label class="switch"><input type="checkbox" id="optExtraSpaces" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Remove Leading Spaces (Trim Start)</span>
                                    <label class="switch"><input type="checkbox" id="optLeadSpaces" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Remove Trailing Spaces (Trim End)</span>
                                    <label class="switch"><input type="checkbox" id="optTrailSpaces" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Remove Spaces Before Punctuation</span>
                                    <label class="switch"><input type="checkbox" id="optSpacePunct" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Convert Tabs to Spaces</span>
                                    <label class="switch"><input type="checkbox" id="optTabsToSpaces" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item" style="border-top: 1px dashed var(--border-color); padding-top: 12px;">
                                    <span class="option-label">Spaces per Tab:</span>
                                    <input type="number" id="valTabSpaces" class="custom-input" value="1" min="1" max="8">
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="group-title"><i class="fas fa-align-left"></i> Line Break Settings</div>
                            <div class="group-content">
                                <div class="option-item">
                                    <span class="option-label">Remove Empty Lines</span>
                                    <label class="switch"><input type="checkbox" id="optEmptyLines" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Compress Multiple Line Breaks into One</span>
                                    <label class="switch"><input type="checkbox" id="optMultLines" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Compress Entire Text to Single Line</span>
                                    <label class="switch"><input type="checkbox" id="optSingleLine"><span class="slider"></span></label>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <div class="group-title"><i class="fas fa-shield-alt"></i> Advanced Settings</div>
                            <div class="group-content">
                                <div class="option-item">
                                    <span class="option-label">Remove Invisible/Zero-Width Characters</span>
                                    <label class="switch"><input type="checkbox" id="optInvisible" checked><span class="slider"></span></label>
                                </div>
                                <div class="option-item">
                                    <span class="option-label">Live Cleaning Mode</span>
                                    <label class="switch"><input type="checkbox" id="optLive"><span class="slider"></span></label>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="primary-actions">
                        <button class="btn-process" id="btnClean">
                            <i class="fas fa-magic"></i> Clean Text Now (Ctrl+Enter)
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-keyboard" style="color: var(--text-muted)"></i> Original Text
                        </div>
                        <div class="toolbar-group">
                            <button class="icon-btn" id="btnPaste"><i class="fas fa-clipboard"></i> Paste</button>
                            <button class="icon-btn danger" id="btnClear"><i class="fas fa-trash-alt"></i> Clear</button>
                        </div>
                    </div>

                    <div class="editor-wrapper">
                        <textarea id="textInput" placeholder="Paste your messy, unformatted text here...&#10;&#10;   Example   with    way too   much space.&#10;&#10;&#10;And empty lines."></textarea>
                    </div>

                    <div class="editor-status">
                        <span class="stats-badge" id="inChars">0 Chars</span>
                        <span class="stats-badge" id="inWords">0 Words</span>
                        <span class="stats-badge" id="inLines">0 Lines</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-check-circle" style="color: var(--accent-green)"></i> Cleaned Result
                        </div>
                        <div class="toolbar-group">
                            <button class="icon-btn" id="btnDiff" title="Toggle Diff View"><i class="fas fa-eye"></i> View Removed</button>
                            <button class="icon-btn" id="btnCopy" style="color: var(--primary-blue); border-color: var(--border-color);"><i class="far fa-copy"></i> Copy</button>
                            <button class="icon-btn" id="btnDownload" style="color: var(--accent-green); border-color: var(--border-color);"><i class="fas fa-download"></i> Save</button>
                        </div>
                    </div>

                    <div class="editor-wrapper" style="position: relative;">
                        <textarea id="textOutput" readonly placeholder="Cleaned text will appear here..."></textarea>
                        <div id="diffPreview" class="diff-preview"></div>
                    </div>
                    
                    <div class="summary-dashboard">
                        <div class="summary-box">
                            <div class="summary-val" id="remSpaces">0</div>
                            <div class="summary-label">Spaces</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-val" id="remBreaks">0</div>
                            <div class="summary-label">Breaks</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-val" id="remTabs">0</div>
                            <div class="summary-label">Tabs</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-val" id="remChars">0</div>
                            <div class="summary-label">Total</div>
                        </div>
                    </div>

                    <div class="proc-time" id="procTime">Processing time: 0 ms</div>
                </div>

            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            © 2026 PassionTools. Secure client-side processing. No data is stored on our servers.
        </div>
    </footer>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMsg">Success</span>
    </div>

    <script>
        /**
         * PASSIONTOOLS - WHITESPACE CLEANER
         * High-performance Regex-based formatting engine
         */

        const DOM = {
            themeToggle: document.getElementById('themeToggle'),
            iconLightbulb: document.querySelector('.theme-toggle i'),
            
            textInput: document.getElementById('textInput'),
            textOutput: document.getElementById('textOutput'),
            diffPreview: document.getElementById('diffPreview'),
            
            inChars: document.getElementById('inChars'),
            inWords: document.getElementById('inWords'),
            inLines: document.getElementById('inLines'),
            
            remSpaces: document.getElementById('remSpaces'),
            remBreaks: document.getElementById('remBreaks'),
            remTabs: document.getElementById('remTabs'),
            remChars: document.getElementById('remChars'),
            procTime: document.getElementById('procTime'),
            
            // Options
            optExtraSpaces: document.getElementById('optExtraSpaces'),
            optLeadSpaces: document.getElementById('optLeadSpaces'),
            optTrailSpaces: document.getElementById('optTrailSpaces'),
            optSpacePunct: document.getElementById('optSpacePunct'),
            optTabsToSpaces: document.getElementById('optTabsToSpaces'),
            valTabSpaces: document.getElementById('valTabSpaces'),
            optEmptyLines: document.getElementById('optEmptyLines'),
            optMultLines: document.getElementById('optMultLines'),
            optSingleLine: document.getElementById('optSingleLine'),
            optInvisible: document.getElementById('optInvisible'),
            optLive: document.getElementById('optLive'),
            
            // Buttons
            btnClean: document.getElementById('btnClean'),
            btnPaste: document.getElementById('btnPaste'),
            btnClear: document.getElementById('btnClear'),
            btnDiff: document.getElementById('btnDiff'),
            btnCopy: document.getElementById('btnCopy'),
            btnDownload: document.getElementById('btnDownload'),
            
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toastMsg')
        };

        let isDiffMode = false;
        let lastInputText = '';
        let lastProcessedText = '';

        // --- Theme Management ---
        function checkThemePreference() {
            if (localStorage.getItem('passion_theme') === 'dark' || 
               (!localStorage.getItem('passion_theme') && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.setAttribute('data-theme', 'dark');
                DOM.iconLightbulb.className = 'fas fa-lightbulb';
                DOM.iconLightbulb.style.color = '#fbbf24';
            } else {
                document.body.removeAttribute('data-theme');
                DOM.iconLightbulb.className = 'far fa-lightbulb';
                DOM.iconLightbulb.style.color = '';
            }
        }

        DOM.themeToggle.addEventListener('click', () => {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('passion_theme', 'light');
                DOM.iconLightbulb.className = 'far fa-lightbulb';
                DOM.iconLightbulb.style.color = '';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('passion_theme', 'dark');
                DOM.iconLightbulb.className = 'fas fa-lightbulb';
                DOM.iconLightbulb.style.color = '#fbbf24';
            }
        });

        // --- Options Logic Handling ---
        // Disable tab space input if toggle is off
        DOM.optTabsToSpaces.addEventListener('change', (e) => {
            DOM.valTabSpaces.disabled = !e.target.checked;
            triggerLiveClean();
        });

        // If Single Line is checked, it overrides empty lines and multi lines
        DOM.optSingleLine.addEventListener('change', (e) => {
            if(e.target.checked) {
                DOM.optEmptyLines.disabled = true;
                DOM.optMultLines.disabled = true;
            } else {
                DOM.optEmptyLines.disabled = false;
                DOM.optMultLines.disabled = false;
            }
            triggerLiveClean();
        });

        // --- Core Cleaning Engine ---
        function cleanText(triggerAnimation = false) {
            const t0 = performance.now();
            let text = DOM.textInput.value;
            lastInputText = text;

            // Pre-processing Counters
            const origSpaces = (text.match(/ /g) || []).length;
            const origTabs = (text.match(/\t/g) || []).length;
            const origLines = (text.match(/\n/g) || []).length;
            const origLen = text.length;

            if (!text) {
                resetOutputs();
                return;
            }

            // 1. Invisible Characters (Zero-width spaces, BOM, etc)
            if (DOM.optInvisible.checked) {
                text = text.replace(/[\u200B-\u200D\uFEFF]/g, '');
            }

            // 2. Tabs to Spaces
            if (DOM.optTabsToSpaces.checked) {
                const spaceCount = parseInt(DOM.valTabSpaces.value) || 1;
                const spaces = ' '.repeat(spaceCount);
                text = text.replace(/\t/g, spaces);
            }

            // 3. Compress Extra Spaces Between Words
            if (DOM.optExtraSpaces.checked) {
                // Replace 2 or more spaces/tabs with 1 space (ignoring newlines)
                text = text.replace(/[ \t]{2,}/g, ' ');
            }

            // 4. Trim Lines (Leading / Trailing)
            if (DOM.optLeadSpaces.checked || DOM.optTrailSpaces.checked) {
                const lines = text.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (DOM.optLeadSpaces.checked) lines[i] = lines[i].replace(/^[ \t]+/, '');
                    if (DOM.optTrailSpaces.checked) lines[i] = lines[i].replace(/[ \t]+$/, '');
                }
                text = lines.join('\n');
            }

            // 5. Remove Spaces Before Punctuation
            if (DOM.optSpacePunct.checked) {
                // Remove spaces before , . : ; ! ? 
                text = text.replace(/[ \t]+([.,:;!?])/g, '$1');
            }

            // 6. Line Breaks Handling
            if (DOM.optSingleLine.checked) {
                // Compress entire text to single line
                text = text.replace(/[\r\n]+/g, ' ');
                if (DOM.optExtraSpaces.checked) text = text.replace(/[ \t]{2,}/g, ' '); // re-compress if needed
            } else {
                if (DOM.optEmptyLines.checked) {
                    // Remove empty lines entirely (lines with only whitespace are already trimmed if Trim is on)
                    text = text.replace(/^[\r\n]+|[\r\n]+$/g, ''); // start/end
                    text = text.replace(/[\r\n]{2,}/g, '\n');
                } else if (DOM.optMultLines.checked) {
                    // Max 2 consecutive line breaks (1 empty line)
                    text = text.replace(/[\r\n]{3,}/g, '\n\n');
                }
            }

            lastProcessedText = text;
            DOM.textOutput.value = text;

            // Post-processing Counters
            const newSpaces = (text.match(/ /g) || []).length;
            const newTabs = (text.match(/\t/g) || []).length;
            const newLines = (text.match(/\n/g) || []).length;
            const newLen = text.length;

            const diffSpaces = Math.max(0, origSpaces - newSpaces);
            const diffTabs = Math.max(0, origTabs - newTabs);
            const diffLines = Math.max(0, origLines - newLines);
            const diffTotal = Math.max(0, origLen - newLen);

            // Update UI
            animateValue(DOM.remSpaces, diffSpaces);
            animateValue(DOM.remTabs, diffTabs);
            animateValue(DOM.remBreaks, diffLines);
            animateValue(DOM.remChars, diffTotal);

            const t1 = performance.now();
            DOM.procTime.textContent = `Processing time: ${(t1 - t0).toFixed(2)} ms`;

            if (isDiffMode) generateDiffPreview(lastInputText, text);
        }

        // --- Simple Diff Generator (Visualizer) ---
        function generateDiffPreview(original, cleaned) {
            // A basic visualizer: show original text but highlight what was removed.
            // Since this tool mainly removes whitespace, we compare lengths and show spaces.
            
            // For a robust diff, we'd need a diffing library. 
            // Here we do a simplified regex replacement on the *original* text to highlight spaces/newlines that the current ruleset targets.
            
            let html = original
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            if (DOM.optExtraSpaces.checked) {
                html = html.replace(/([ \t]{2,})/g, '<span class="removed-space">$1</span>');
            }
            if (DOM.optEmptyLines.checked) {
                 html = html.replace(/(\n\s*\n)/g, '<span class="removed-newline">\n</span>\n');
            }
            if (DOM.optTabsToSpaces.checked) {
                html = html.replace(/(\t)/g, '<span class="removed-space" title="Tab">→</span>');
            }

            DOM.diffPreview.innerHTML = html;
        }

        // --- Helpers ---
        function updateInputStats() {
            const text = DOM.textInput.value;
            DOM.inChars.textContent = `${text.length} Chars`;
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            DOM.inWords.textContent = `${words} Words`;
            const lines = text === '' ? 0 : text.split('\n').length;
            DOM.inLines.textContent = `${lines} Lines`;
        }

        function resetOutputs() {
            DOM.textOutput.value = '';
            DOM.diffPreview.innerHTML = '';
            DOM.remSpaces.textContent = '0';
            DOM.remTabs.textContent = '0';
            DOM.remBreaks.textContent = '0';
            DOM.remChars.textContent = '0';
            DOM.procTime.textContent = 'Processing time: 0 ms';
        }

        function animateValue(obj, end) {
            const start = parseInt(obj.innerHTML.replace(/,/g, '')) || 0;
            if (start === end) return;
            if(end > 10000) { obj.innerHTML = end.toLocaleString(); return; } // skip long anim

            const duration = 400; 
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentVal = Math.floor(progress * (end - start) + start);
                obj.innerHTML = currentVal.toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
                else obj.innerHTML = end.toLocaleString();
            };
            window.requestAnimationFrame(step);
        }

        function showToast(msg, type = 'success') {
            DOM.toastMsg.textContent = msg;
            DOM.toast.className = `toast show ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            DOM.toast.querySelector('i').className = `fas ${icon}`;
            setTimeout(() => DOM.toast.classList.remove('show'), 3000);
        }

        // --- Event Listeners ---
        
        let debounceTimer;
        function triggerLiveClean() {
            if (DOM.optLive.checked) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(cleanText, 100);
            }
        }

        DOM.textInput.addEventListener('input', () => {
            updateInputStats();
            triggerLiveClean();
        });

        // Trigger on any checkbox change
        document.querySelectorAll('.options-panel input[type="checkbox"], .options-panel input[type="number"]').forEach(el => {
            el.addEventListener('change', triggerLiveClean);
        });

        DOM.btnClean.addEventListener('click', () => {
            cleanText(true);
            showToast('Text cleaned successfully!', 'success');
        });

        // Keyboard Shortcut (Ctrl+Enter)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                DOM.btnClean.click();
            }
        });

        DOM.btnClear.addEventListener('click', () => {
            DOM.textInput.value = '';
            updateInputStats();
            resetOutputs();
            DOM.textInput.focus();
        });

        DOM.btnPaste.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                DOM.textInput.value += text;
                updateInputStats();
                if(DOM.optLive.checked) cleanText();
                showToast('Text pasted', 'info');
            } catch (err) {
                alert('Clipboard access denied. Please paste manually using Ctrl+V or Cmd+V.');
            }
        });

        DOM.btnCopy.addEventListener('click', () => {
            const result = DOM.textOutput.value;
            if (!result) return showToast('Nothing to copy', 'info');
            navigator.clipboard.writeText(result).then(() => {
                showToast('Cleaned text copied!', 'success');
            });
        });

        DOM.btnDownload.addEventListener('click', () => {
            const result = DOM.textOutput.value;
            if (!result) return;
            const blob = new Blob([result], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `passiontools_cleaned_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('File saved successfully!', 'success');
        });

        DOM.btnDiff.addEventListener('click', () => {
            isDiffMode = !isDiffMode;
            if (isDiffMode) {
                DOM.diffPreview.classList.add('active');
                DOM.textOutput.style.opacity = '0';
                DOM.btnDiff.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Removed';
                DOM.btnDiff.style.borderColor = 'var(--accent-orange)';
                DOM.btnDiff.style.color = 'var(--accent-orange)';
                generateDiffPreview(lastInputText, lastProcessedText);
            } else {
                DOM.diffPreview.classList.remove('active');
                DOM.textOutput.style.opacity = '1';
                DOM.btnDiff.innerHTML = '<i class="fas fa-eye"></i> View Removed';
                DOM.btnDiff.style.borderColor = 'var(--border-color)';
                DOM.btnDiff.style.color = 'var(--text-main)';
            }
        });

        // --- Init ---
        function init() {
            checkThemePreference();
            updateInputStats();
            // Optional: Restore state from localStorage here if desired
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
